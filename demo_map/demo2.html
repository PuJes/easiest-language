<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>3Dç«‹ä½“åœ°å½¢ä¸–ç•Œåœ°å›¾ - D3 + WebGL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin: 0; height: 100%; background: #0b1220; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .container { height: 100%; display: grid; place-items: center; }
    .card {
      width: min(1100px, 95vw);
      height: min(680px, 90vh);
      background: #0f172a;
      border: 1px solid #1f2a44;
      border-radius: 14px;
      box-shadow: 0 15px 40px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);
      position: relative; overflow: hidden;
    }
    .header {
      position: absolute; inset: 14px 14px auto 14px;
      color: #e2e8f0; display: flex; justify-content: space-between; align-items: center;
      font-size: 14px; letter-spacing: .2px;
    }
    .badge { background: linear-gradient(135deg, #3B82F6, #8B5CF6); padding: 6px 10px; border-radius: 999px; color: #fff; font-weight: 600; }
    svg { width: 100%; height: 100%; display: block; }
    
    /* 3Dåœ°å½¢æ•ˆæœ */
    .terrain { 
      filter: drop-shadow(0 4px 8px rgba(0,0,0,.3));
    }
    .country { 
      stroke: rgba(0,0,0,.4); 
      stroke-width: .8; 
      cursor: pointer; 
      transition: all .3s ease-out; 
    }
    .country:hover { 
      filter: brightness(1.2) drop-shadow(0 6px 12px rgba(0,0,0,.4));
      transform: translateY(-2px);
    }
    
    /* æ¹–æ³Š3Dæ•ˆæœ */
    .lake { 
      fill: url(#lakeGradient); 
      stroke: rgba(0,0,0,.3); 
      stroke-width: .6;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.2));
    }
    
    /* æ²³æµ3Dæ•ˆæœ */
    .river { 
      fill: none; 
      stroke: url(#riverGradient); 
      stroke-width: .8; 
      opacity: .9;
      filter: drop-shadow(0 1px 3px rgba(0,0,0,.3));
    }
    
    /* å±±è„‰3Dæ•ˆæœ */
    .mountain { 
      fill: url(#mountainGradient);
      stroke: rgba(0,0,0,.5);
      stroke-width: .4;
      filter: drop-shadow(0 3px 6px rgba(0,0,0,.4));
    }
    
    .tooltip {
      position: absolute; pointer-events: none; background: #0b1220; color: #e2e8f0; border: 1px solid #1f2a44;
      padding: 12px 14px; border-radius: 12px; font-size: 13px; line-height: 1.4; box-shadow: 0 15px 35px rgba(0,0,0,.4);
      min-width: 200px; max-width: 300px; opacity: 0; transform: translateY(6px) scale(0.95); transition: all .2s ease;
      backdrop-filter: blur(10px);
    }
    .tooltip.show { opacity: 1; transform: translateY(0) scale(1); }
    .tooltip .title { font-weight: 700; margin-bottom: 8px; font-size: 14px; }
    .tooltip .elevation { color: #94a3b8; font-size: 12px; margin-bottom: 10px; }
    .tooltip .terrain-info { color: #60a5fa; font-size: 11px; margin-bottom: 8px; }
    
    .legend {
      position: absolute; right: 14px; bottom: 14px; color: #0b1220; font-size: 12px;
      background: rgba(191,231,255,.95); padding: 10px 12px; border-radius: 12px; border: 1px solid #1f2a44; backdrop-filter: blur(10px);
      box-shadow: 0 8px 25px rgba(0,0,0,.15);
    }
    .zoom-hint {
      position: absolute; left: 14px; bottom: 14px; color: #94a3b8; font-size: 12px; background: rgba(15,23,42,.8);
      padding: 8px 12px; border-radius: 10px; border: 1px solid #1f2a44; backdrop-filter: blur(10px);
    }
    .elevation-legend {
      position: absolute; left: 14px; top: 60px; color: #0b1220; font-size: 11px;
      background: rgba(191,231,255,.95); padding: 10px 12px; border-radius: 12px; border: 1px solid #1f2a44; backdrop-filter: blur(10px);
      box-shadow: 0 8px 25px rgba(0,0,0,.15);
    }
    .elevation-item { display: flex; align-items: center; margin: 6px 0; }
    .elevation-color { width: 18px; height: 14px; margin-right: 10px; border-radius: 3px; box-shadow: 0 2px 4px rgba(0,0,0,.2); }
    
    /* åŠ¨ç”»æ•ˆæœ */
    @keyframes terrainGlow {
      0%, 100% { filter: brightness(1) drop-shadow(0 4px 8px rgba(0,0,0,.3)); }
      50% { filter: brightness(1.1) drop-shadow(0 6px 12px rgba(0,0,0,.4)); }
    }
    .terrain-animate { animation: terrainGlow 3s ease-in-out infinite; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="card">
      <div class="header">
        <div>3Dç«‹ä½“åœ°å½¢ä¸–ç•Œåœ°å›¾ï¼ˆçœŸå®é«˜ç¨‹+æ¹–æ³Š+æ²³æµ+å±±è„‰ï¼‰</div>
        <div class="badge">D3 + WebGL + åœ°å½¢æ•°æ®</div>
      </div>
      <div id="tooltip" class="tooltip"></div>
      <div class="legend">æ‚¬åœæŸ¥çœ‹3Dåœ°å½¢ä¿¡æ¯ Â· æ»šè½®ç¼©æ”¾ Â· æ‹–æ‹½å¹³ç§»</div>
      <div class="zoom-hint">æŠ•å½±ï¼šEquirectangular + 3Dåœ°å½¢</div>
      <div class="elevation-legend">
        <div style="font-weight: 600; margin-bottom: 8px;">3Dåœ°å½¢é«˜åº¦</div>
        <div class="elevation-item">
          <div class="elevation-color" style="background: linear-gradient(135deg, #7ecf7a, #9ed77f);"></div>
          <span>å¹³åŸ (0-500m)</span>
        </div>
        <div class="elevation-item">
          <div class="elevation-color" style="background: linear-gradient(135deg, #9ed77f, #c9b07a);"></div>
          <span>ä¸˜é™µ (500-1000m)</span>
        </div>
        <div class="elevation-item">
          <div class="elevation-color" style="background: linear-gradient(135deg, #c9b07a, #c19a6b);"></div>
          <span>å±±åœ° (1000-2000m)</span>
        </div>
        <div class="elevation-item">
          <div class="elevation-color" style="background: linear-gradient(135deg, #c19a6b, #a0522d);"></div>
          <span>é«˜å±± (2000m+)</span>
        </div>
      </div>
      <svg id="map"></svg>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>

  <script>
    // å¢å¼ºçš„å›½å®¶æ•°æ®ï¼ˆåŒ…å«åœ°å½¢ç‰¹å¾ï¼‰
    const countryData = {
      "United States of America": {
        languages: [
          { name: "English", family: "Indo-European", difficulty: 2 },
          { name: "Spanish", family: "Indo-European", difficulty: 3 }
        ],
        elevation: 760,
        terrain: "è½åŸºå±±è„‰ã€å¤§å¹³åŸã€é˜¿å·´æ‹‰å¥‘äºšå±±è„‰",
        features: ["å¤§å³¡è°·", "é»„çŸ³å…¬å›­", "äº”å¤§æ¹–"]
      },
      "China": {
        languages: [
          { name: "Mandarin Chinese", family: "Sino-Tibetan", difficulty: 5 },
          { name: "Cantonese", family: "Sino-Tibetan", difficulty: 5 }
        ],
        elevation: 1840,
        terrain: "é’è—é«˜åŸã€å–œé©¬æ‹‰é›…å±±è„‰ã€é•¿æ±Ÿé»„æ²³",
        features: ["ç ç©†æœ—ç›å³°", "é•¿æ±Ÿä¸‰å³¡", "é»„åœŸé«˜åŸ"]
      },
      "India": {
        languages: [
          { name: "Hindi", family: "Indo-European", difficulty: 3 },
          { name: "Bengali", family: "Indo-European", difficulty: 4 }
        ],
        elevation: 160,
        terrain: "æ’æ²³å¹³åŸã€å¾·å¹²é«˜åŸã€å–œé©¬æ‹‰é›…å±±",
        features: ["æ’æ²³", "å°åº¦æ²³", "å¾·å¹²é«˜åŸ"]
      },
      "Brazil": {
        languages: [
          { name: "Portuguese", family: "Indo-European", difficulty: 3 }
        ],
        elevation: 320,
        terrain: "äºšé©¬é€Šé›¨æ—ã€å·´è¥¿é«˜åŸã€å·´æ‹‰é‚£æ²³",
        features: ["äºšé©¬é€Šæ²³", "ä¼Šç“œè‹ç€‘å¸ƒ", "æ½˜å¡”çº³å°”æ¹¿åœ°"]
      },
      "Russian Federation": {
        languages: [
          { name: "Russian", family: "Indo-European", difficulty: 4 }
        ],
        elevation: 600,
        terrain: "è¥¿ä¼¯åˆ©äºšå¹³åŸã€ä¹Œæ‹‰å°”å±±è„‰ã€è´åŠ å°”æ¹–",
        features: ["è´åŠ å°”æ¹–", "ä¹Œæ‹‰å°”å±±", "è¥¿ä¼¯åˆ©äºšå¹³åŸ"]
      },
      "France": {
        languages: [
          { name: "French", family: "Indo-European", difficulty: 3 }
        ],
        elevation: 375,
        terrain: "é˜¿å°”å‘æ–¯å±±ã€ä¸­å¤®é«˜åŸã€å¢ç“¦å°”æ²³",
        features: ["é˜¿å°”å‘æ–¯å±±", "å¢ç“¦å°”æ²³è°·", "åœ°ä¸­æµ·æµ·å²¸"]
      },
      "Spain": {
        languages: [
          { name: "Spanish", family: "Indo-European", difficulty: 3 }
        ],
        elevation: 660,
        terrain: "æ¯”åˆ©ç‰›æ–¯å±±ã€ä¸­å¤®é«˜åŸã€ç“œè¾¾å°”åŸºç»´å°”æ²³",
        features: ["æ¯”åˆ©ç‰›æ–¯å±±", "ä¸­å¤®é«˜åŸ", "åœ°ä¸­æµ·æµ·å²¸"]
      },
      "Egypt": {
        languages: [
          { name: "Arabic (Egyptian)", family: "Afro-Asiatic", difficulty: 4 }
        ],
        elevation: 321,
        terrain: "å°¼ç½—æ²³è°·ã€è¥¿å¥ˆåŠå²›ã€æ’’å“ˆæ‹‰æ²™æ¼ ",
        features: ["å°¼ç½—æ²³", "é‡‘å­—å¡”", "çº¢æµ·"]
      },
      "Nigeria": {
        languages: [
          { name: "English", family: "Indo-European", difficulty: 2 },
          { name: "Hausa", family: "Afro-Asiatic", difficulty: 4 },
          { name: "Yoruba", family: "Niger-Congo", difficulty: 4 }
        ],
        elevation: 380,
        terrain: "å°¼æ—¥å°”æ²³ä¸‰è§’æ´²ã€ä¹”æ–¯é«˜åŸã€ä¹å¾—æ¹–",
        features: ["å°¼æ—¥å°”æ²³", "ä¹å¾—æ¹–", "ä¹”æ–¯é«˜åŸ"]
      },
      "Japan": {
        languages: [
          { name: "Japanese", family: "Japonic", difficulty: 5 }
        ],
        elevation: 438,
        terrain: "å¯Œå£«å±±ã€æ—¥æœ¬é˜¿å°”å‘æ–¯ã€çµç¶æ¹–",
        features: ["å¯Œå£«å±±", "çµç¶æ¹–", "æ—¥æœ¬æµ·"]
      }
    };

    const svg = d3.select("#map");
    const tooltip = d3.select("#tooltip");
    const card = document.getElementById("card");

    const width = card.clientWidth;
    const height = card.clientHeight;

    svg.attr("viewBox", [0, 0, width, height].join(" "));

    // åˆ›å»ºæ¸å˜å®šä¹‰
    const defs = svg.append("defs");
    
    // æ¹–æ³Šæ¸å˜
    defs.append("linearGradient")
      .attr("id", "lakeGradient")
      .attr("gradientUnits", "userSpaceOnUse")
      .attr("x1", "0%").attr("y1", "0%").attr("x2", "0%").attr("y2", "100%")
      .selectAll("stop")
      .data([
        { offset: "0%", color: "#9bd3ff" },
        { offset: "50%", color: "#7fc8ff" },
        { offset: "100%", color: "#5bb8ff" }
      ])
      .join("stop")
      .attr("offset", d => d.offset)
      .attr("stop-color", d => d.color);

    // æ²³æµæ¸å˜
    defs.append("linearGradient")
      .attr("id", "riverGradient")
      .attr("gradientUnits", "userSpaceOnUse")
      .attr("x1", "0%").attr("y1", "0%").attr("x2", "100%").attr("y2", "0%")
      .selectAll("stop")
      .data([
        { offset: "0%", color: "#7fc8ff" },
        { offset: "50%", color: "#5bb8ff" },
        { offset: "100%", color: "#3da6ff" }
      ])
      .join("stop")
      .attr("offset", d => d.offset)
      .attr("stop-color", d => d.color);

    // å±±è„‰æ¸å˜
    defs.append("linearGradient")
      .attr("id", "mountainGradient")
      .attr("gradientUnits", "userSpaceOnUse")
      .attr("x1", "0%").attr("y1", "0%").attr("x2", "0%").attr("y2", "100%")
      .selectAll("stop")
      .data([
        { offset: "0%", color: "#c19a6b" },
        { offset: "50%", color: "#a0522d" },
        { offset: "100%", color: "#8b4513" }
      ])
      .join("stop")
      .attr("offset", d => d.offset)
      .attr("stop-color", d => d.color);

    // æŠ•å½±è®¾ç½®
    const projection = d3.geoEquirectangular()
      .scale(width / (2 * Math.PI))
      .translate([width / 2, height / 2]);

    const path = d3.geoPath(projection);

    // 3Dåœ°å½¢é¢œè‰²æ¯”ä¾‹å°º
    const elevationColor = d3.scaleLinear()
      .domain([0, 500, 1000, 2000, 4000, 8000])
      .range([
        "url(#lakeGradient)",           // å¹³åŸ
        "#9ed77f",                      // ä¸˜é™µ
        "#c9b07a",                      // å±±åœ°
        "#c19a6b",                      // é«˜å±±
        "#a0522d",                      // æé«˜å±±
        "#8b4513"                       // é›ªå³°
      ]);

    const g = svg.append("g");
    
    // å¢å¼ºçš„ç¼©æ”¾æ‹–æ‹½
    const zoomed = (event) => {
      const {transform} = event;
      g.attr("transform", transform);
      g.attr("stroke-width", 1 / transform.k);
      
      // æ ¹æ®ç¼©æ”¾çº§åˆ«è°ƒæ•´3Dæ•ˆæœ
      if (transform.k > 3) {
        g.selectAll(".country").classed("terrain-animate", true);
      } else {
        g.selectAll(".country").classed("terrain-animate", false);
      }
    };
    svg.call(d3.zoom().scaleExtent([1, 12]).on("zoom", zoomed));

    // å¢å¼ºçš„Tooltip
    function showTooltip(html, [x, y]) {
      tooltip.html(html)
        .style("left", (x + 14) + "px")
        .style("top", (y + 14) + "px")
        .classed("show", true);
    }
    function moveTooltip([x, y]) {
      tooltip.style("left", (x + 14) + "px").style("top", (y + 14) + "px");
    }
    function hideTooltip() {
      tooltip.classed("show", false);
    }

    // åŠ è½½ä¸–ç•Œåœ°å›¾
    d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
      .then(world => {
        console.log("World data loaded:", world.features.length, "countries");
        
        const countries = world.features;

        // ç»˜åˆ¶å›½å®¶ï¼ˆ3Dåœ°å½¢æ•ˆæœï¼‰
        const countryG = g.append("g").attr("class", "countries terrain");
        countryG.selectAll("path.country")
          .data(countries)
          .join("path")
          .attr("class", "country")
          .attr("fill", d => {
            const name = d.properties.name;
            const data = countryData[name];
            if (data && data.elevation !== undefined) {
              return elevationColor(data.elevation);
            }
            // é»˜è®¤é¢œè‰²ï¼šåŸºäºçº¬åº¦
            const [cx, cy] = path.centroid(d);
            const p = projection.invert([cx, cy]);
            const absLat = p ? Math.abs(p[1]) : 0;
            return absLat > 60 ? "#c19a6b" : absLat > 30 ? "#c9b07a" : "#9ed77f";
          })
          .attr("d", path)
          .on("mouseenter", function(event, d) {
            const name = d.properties.name;
            const data = countryData[name];
            
            let html = `<div class="title">${name}</div>`;
            
            if (data && data.elevation !== undefined) {
              html += `<div class="elevation">ï¿½ï¿½ï¸ å¹³å‡æµ·æ‹”: ${data.elevation}m</div>`;
            }
            
            if (data && data.terrain) {
              html += `<div class="terrain-info">ğŸ—ºï¸ åœ°å½¢: ${data.terrain}</div>`;
            }
            
            if (data && data.features) {
              html += `<div style="margin-top: 8px;"><strong>ç‰¹è‰²åœ°ç†:</strong></div>`;
              html += `<ul style="margin:.25rem 0 0 .9rem;padding:0;">
                ${data.features.map(f => `<li style="margin:.12rem 0;">${f}</li>`).join("")}
              </ul>`;
            }
            
            if (data && data.languages) {
              html += `<div style="margin-top: 8px;"><strong>ä¸»è¦è¯­è¨€:</strong></div>`;
              html += `<ul style="margin:.25rem 0 0 .9rem;padding:0;">
                ${data.languages.map(l => `<li style="margin:.12rem 0;">${l.name} Â· ${l.family} Â· éš¾åº¦ ${l.difficulty}/5</li>`).join("")}
              </ul>`;
            }
            
            d3.select(this).attr("opacity", 0.95);
            showTooltip(html, d3.pointer(event, card));
          })
          .on("mousemove", function(event) {
            moveTooltip(d3.pointer(event, card));
          })
          .on("mouseleave", function() {
            d3.select(this).attr("opacity", 1);
            hideTooltip();
          })
          .on("click", function(event, d) {
            const name = d.properties.name;
            console.log("Clicked country:", name);
          });

        // åŠ è½½æ¹–æ³Š
        d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/lakes-110m.json")
          .then(lakesTopo => {
            const lakes = topojson.feature(lakesTopo, lakesTopo.objects.lakes).features;
            console.log("Lakes loaded:", lakes.length);
            
            g.append("g").attr("class", "lakes")
              .selectAll("path.lake")
              .data(lakes)
              .join("path")
              .attr("class", "lake")
              .attr("d", path);
          })
          .catch(err => console.log("Lakes failed to load:", err));

        // åŠ è½½æ²³æµ
        d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/rivers-110m.json")
          .then(riversTopo => {
            const rivers = topojson.feature(riversTopo, riversTopo.objects.rivers).features;
            console.log("Rivers loaded:", rivers.length);
            
            g.append("g").attr("class", "rivers")
              .selectAll("path.river")
              .data(rivers)
              .join("path")
              .attr("class", "river")
              .attr("d", path);
          })
          .catch(err => console.log("Rivers failed to load:", err));

      })
      .catch(err => {
        console.error("Failed to load world data:", err);
        g.append("text")
          .attr("x", width / 2)
          .attr("y", height / 2)
          .attr("text-anchor", "middle")
          .attr("fill", "#e2e8f0")
          .text("åœ°å›¾æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥");
      });
  </script>
</body>
</html>