<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>2D 世界地图 Demo - D3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin: 0; height: 100%; background: #0b1220; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .container { height: 100%; display: grid; place-items: center; }
    .card {
      width: min(1100px, 95vw);
      height: min(680px, 90vh);
      background: #0f172a;
      border: 1px solid #1f2a44;
      border-radius: 14px;
      box-shadow: 0 15px 40px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);
      position: relative; overflow: hidden;
    }
    .header {
      position: absolute; inset: 14px 14px auto 14px;
      color: #e2e8f0; display: flex; justify-content: space-between; align-items: center;
      font-size: 14px; letter-spacing: .2px;
    }
    .badge { background: linear-gradient(135deg, #3B82F6, #8B5CF6); padding: 6px 10px; border-radius: 999px; color: #fff; font-weight: 600; }
    svg { width: 100%; height: 100%; display: block; }
    .sphere { fill: #bfe7ff; stroke: rgba(255,255,255,.22); stroke-width: .8; }
    .country { 
      fill: #a7d38a; 
      stroke: rgba(0,0,0,.28); 
      stroke-width: .6; 
      cursor: pointer; 
      transition: fill .15s ease-out, opacity .15s ease-out; 
    }
    .country:hover { fill: #8bc34a; opacity: .9; }
    .tooltip {
      position: absolute; pointer-events: none; background: #0b1220; color: #e2e8f0; border: 1px solid #1f2a44;
      padding: 10px 12px; border-radius: 10px; font-size: 13px; line-height: 1.4; box-shadow: 0 10px 25px rgba(0,0,0,.35);
      min-width: 180px; max-width: 280px; opacity: 0; transform: translateY(6px); transition: opacity .12s ease, transform .12s ease;
    }
    .tooltip .title { font-weight: 700; margin-bottom: 6px; }
    .legend {
      position: absolute; right: 14px; bottom: 14px; color: #94a3b8; font-size: 12px; background: rgba(15,23,42,.6);
      padding: 8px 10px; border-radius: 10px; border: 1px solid #1f2a44; backdrop-filter: blur(6px);
    }
    .zoom-hint {
      position: absolute; left: 14px; bottom: 14px; color: #94a3b8; font-size: 12px; background: rgba(15,23,42,.6);
      padding: 8px 10px; border-radius: 10px; border: 1px solid #1f2a44; backdrop-filter: blur(6px);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="card">
      <div class="header">
        <div>2D 世界地图（地区/国家 + 语言 Tooltip）</div>
        <div class="badge">D3 + GeoJSON Demo</div>
      </div>
      <div id="tooltip" class="tooltip"></div>
      <div class="legend">悬停国家查看示例语言 · 滚轮缩放 · 拖拽平移</div>
      <div class="zoom-hint">投影：Natural Earth 1</div>
      <svg id="map"></svg>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>

  <script>
    const WORLD_GEOJSON_URL = "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson";

    const languagesByCountry = {
      "United States of America": [
        { name: "English", family: "Indo-European", difficulty: 2 },
        { name: "Spanish", family: "Indo-European", difficulty: 3 }
      ],
      "China": [
        { name: "Mandarin Chinese", family: "Sino-Tibetan", difficulty: 5 },
        { name: "Cantonese", family: "Sino-Tibetan", difficulty: 5 }
      ],
      "India": [
        { name: "Hindi", family: "Indo-European", difficulty: 3 },
        { name: "Bengali", family: "Indo-European", difficulty: 4 }
      ],
      "Brazil": [
        { name: "Portuguese", family: "Indo-European", difficulty: 3 }
      ],
      "Russian Federation": [
        { name: "Russian", family: "Indo-European", difficulty: 4 }
      ],
      "France": [
        { name: "French", family: "Indo-European", difficulty: 3 }
      ],
      "Spain": [
        { name: "Spanish", family: "Indo-European", difficulty: 3 }
      ],
      "Egypt": [
        { name: "Arabic (Egyptian)", family: "Afro-Asiatic", difficulty: 4 }
      ],
      "Nigeria": [
        { name: "English", family: "Indo-European", difficulty: 2 },
        { name: "Hausa", family: "Afro-Asiatic", difficulty: 4 },
        { name: "Yoruba", family: "Niger-Congo", difficulty: 4 }
      ],
      "Japan": [
        { name: "Japanese", family: "Japonic", difficulty: 5 }
      ]
    };

    const svg = d3.select("#map");
    const tooltip = d3.select("#tooltip");
    const card = document.getElementById("card");

    const width = card.clientWidth;
    const height = card.clientHeight;

    svg.attr("viewBox", [0, 0, width, height].join(" "));

    const projection = d3.geoNaturalEarth1()
      .fitExtent([[20, 20], [width - 20, height - 20]], {type: "Sphere"});

    const path = d3.geoPath(projection);

    const g = svg.append("g");
    
    // 海洋背景
    g.append("path").datum({type: "Sphere"}).attr("class", "sphere").attr("d", path);

    // 缩放拖拽
    const zoomed = (event) => {
      const {transform} = event;
      g.attr("transform", transform);
      g.attr("stroke-width", 1 / transform.k);
    };
    svg.call(d3.zoom().scaleExtent([1, 8]).on("zoom", zoomed));

    // Tooltip helpers
    function showTooltip(html, [x, y]) {
      tooltip.html(html)
        .style("left", (x + 14) + "px")
        .style("top", (y + 14) + "px")
        .style("opacity", 1)
        .style("transform", "translateY(0)");
    }
    function moveTooltip([x, y]) {
      tooltip.style("left", (x + 14) + "px").style("top", (y + 14) + "px");
    }
    function hideTooltip() {
      tooltip.style("opacity", 0).style("transform", "translateY(6px)");
    }

    // 渲染世界地图（国家边界 + 语言交互）
    d3.json(WORLD_GEOJSON_URL).then(world => {
      const countries = world.features;

      g.append("g")
        .selectAll("path.country")
        .data(countries)
        .join("path")
        .attr("class", "country")
        .attr("d", path)
        .on("mouseenter", function(event, d) {
          const name = d.properties.name;
          const langs = languagesByCountry[name];
          const langList = langs
            ? `<ul style="margin:.25rem 0 0 .9rem;padding:0;">
                 ${langs.map(l => `<li style="margin:.12rem 0;">${l.name} · ${l.family} · 难度 ${l.difficulty}/5</li>`).join("")}
               </ul>`
            : `<div style="opacity:.7;">暂无示例语言</div>`;

          const html = `
            <div class="title">${name}</div>
            ${langList}
          `;
          d3.select(this).attr("opacity", 0.9);
          showTooltip(html, d3.pointer(event, card));
        })
        .on("mousemove", function(event) {
          moveTooltip(d3.pointer(event, card));
        })
        .on("mouseleave", function() {
          d3.select(this).attr("opacity", 1);
          hideTooltip();
        })
        .on("click", function(event, d) {
          const name = d.properties.name;
          console.log("Clicked country:", name);
        });
    }).catch(err => {
      console.error("Failed to load world geojson:", err);
    });
  </script>
</body>
</html>